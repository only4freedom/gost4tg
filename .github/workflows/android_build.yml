name: Build Gost V2 APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        check-latest: true

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        gomobile init

    - name: Build Go Library (AAR)
      run: |
        cd gostlib
        # 强制更新 go.mod 防止版本冲突
        go mod edit -go=1.24
        go mod tidy
        # 【关键修复】增加 -androidapi 21 参数，解决 NDK 报错
        gomobile bind -target=android -androidapi 21 -o ../app/src/main/libs/gostlib.aar .

    - name: Create Gradle Build Files
      run: |
        echo "buildscript { repositories { google(); mavenCentral() } dependencies { classpath 'com.android.tools.build:gradle:7.4.2' } }" > build.gradle
        echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle
        
        echo "apply plugin: 'com.android.application'" > app/build.gradle
        # 这里的 minSdk 也对应改成 21
        echo "android { namespace 'com.example.gostproxy'; compileSdk 33; defaultConfig { applicationId 'com.example.gostproxy'; minSdk 21; targetSdk 33; versionCode 1; versionName '1.0'; } }" >> app/build.gradle
        echo "dependencies { implementation files('src/main/libs/gostlib.aar') }" >> app/build.gradle

    - name: Build APK
      run: gradle assembleDebug --no-daemon

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: gost-v2-proxy.apk
        path: app/build/outputs/apk/debug/app-debug.apk
