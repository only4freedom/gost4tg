name: Build Gost V2 APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        check-latest: true

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        gomobile init

    - name: Build Go Library (AAR)
      run: |
        # 1. 准备源码
        rm -rf gostlib
        mkdir gostlib
        git clone --depth 1 https://github.com/ginuerzh/gost.git temp_src
        cp temp_src/*.go gostlib/
        rm -rf temp_src
        
        cd gostlib

        # 2. 【核心操作】彻底删除导致报错的复杂功能文件
        # 只保留 HTTP/SOCKS5 核心，删除 QUIC, KCP, OBFS, SSH, HTTP2 等可选插件
        # 这些文件是依赖地狱的源头
        rm -f quic.go obfs.go kcp.go ssh.go http2.go
        
        # 3. 修改包名为 gostlib
        sed -i 's/^package .*/package gostlib/' *.go

        # 4. 【外科手术】清理残留引用
        # 删除所有包含 git.torproject.org (obfs4) 的 import 行
        sed -i '/git.torproject.org/d' *.go
        # 删除所有包含 quic-go 的 import 行
        sed -i '/quic-go/d' *.go
        # 删除所有包含 kcp-go 的 import 行
        sed -i '/kcp-go/d' *.go
        
        # 注释掉所有调用了 quic/obfs/kcp/ssh 功能的代码行
        # 防止 Go 编译器因为找不到包而报错
        sed -i 's/.*quic\..*/\/\/ &/' *.go
        sed -i 's/.*obfs\..*/\/\/ &/' *.go
        sed -i 's/.*kcp\..*/\/\/ &/' *.go
        sed -i 's/.*ssh\..*/\/\/ &/' *.go
        sed -i 's/.*http2\..*/\/\/ &/' *.go

        # 5. 创建启动器 wrapper.go
        cat <<EOW > wrapper.go
        package gostlib
        import ("flag"; "os")
        func Start(configPath string) {
            flag.CommandLine = flag.NewFlagSet(os.Args[0], flag.ExitOnError)
            os.Args = []string{"gost", "-C", configPath}
            Run()
        }
        EOW

        # 6. 创建假引用保活
        echo 'package gostlib' > dummy_import.go
        echo 'import _ "golang.org/x/mobile/bind"' >> dummy_import.go
        
        # 7. 初始化 Module
        go mod init gostlib
        go mod edit -go=1.24
        
        # 8. 【关键】锁定 relay 版本
        # 修复 req.Flags undefined 错误，必须用旧版
        go mod edit -replace github.com/go-gost/relay=github.com/go-gost/relay@v0.1.1
        
        # 9. 下载依赖
        # 注意：这里不再执行 go get github.com/ginuerzh/gost
        go get golang.org/x/mobile/bind
        
        # 让 Go 自动分析剩余的合法依赖 (只剩标准库和基础库了)
        go mod tidy
        
        # 10. 编译
        gomobile bind -target=android -androidapi 21 -o ../app/src/main/libs/gostlib.aar .

    - name: Create Gradle Build Files
      run: |
        echo "buildscript { repositories { google(); mavenCentral() } dependencies { classpath 'com.android.tools.build:gradle:7.4.2' } }" > build.gradle
        echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle
        
        echo "apply plugin: 'com.android.application'" > app/build.gradle
        echo "android { namespace 'com.example.gostproxy'; compileSdk 33; defaultConfig { applicationId 'com.example.gostproxy'; minSdk 21; targetSdk 33; versionCode 1; versionName '1.0'; } }" >> app/build.gradle
        echo "dependencies { implementation files('src/main/libs/gostlib.aar') }" >> app/build.gradle

    - name: Build APK
      run: gradle assembleDebug --no-daemon

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: gost-v2-proxy.apk
        path: app/build/outputs/apk/debug/app-debug.apk
